\hypertarget{cave__render_8c_source}{}\doxysection{cave\+\_\+render.\+c}
\label{cave__render_8c_source}\index{/Users/cwb/developer/learning/graphicRenderEngine/ceres/3rdparty/stb/tests/caveview/cave\_render.c@{/Users/cwb/developer/learning/graphicRenderEngine/ceres/3rdparty/stb/tests/caveview/cave\_render.c}}

\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00001}00001 \textcolor{comment}{// This file renders vertex buffers, converts raw meshes}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00002}00002 \textcolor{comment}{// to GL meshes, and manages threads that do the raw-\/mesh}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00003}00003 \textcolor{comment}{// building (found in cave\_mesher.c)}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00004}00004 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00005}00005 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00006}00006 \textcolor{preprocessor}{\#include "{}stb\_voxel\_render.h"{}}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00007}00007 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00008}00008 \textcolor{preprocessor}{\#define STB\_GLEXT\_DECLARE "{}glext\_list.h"{}}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00009}00009 \textcolor{preprocessor}{\#include "{}stb\_gl.h"{}}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00010}00010 \textcolor{preprocessor}{\#include "{}stb\_image.h"{}}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00011}00011 \textcolor{preprocessor}{\#include "{}stb\_glprog.h"{}}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00012}00012 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00013}00013 \textcolor{preprocessor}{\#include "{}caveview.h"{}}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00014}00014 \textcolor{preprocessor}{\#include "{}cave\_parse.h"{}}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00015}00015 \textcolor{preprocessor}{\#include "{}stb.h"{}}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00016}00016 \textcolor{preprocessor}{\#include "{}sdl.h"{}}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00017}00017 \textcolor{preprocessor}{\#include "{}sdl\_thread.h"{}}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00018}00018 \textcolor{preprocessor}{\#include <math.h>}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00019}00019 \textcolor{preprocessor}{\#include <assert.h>}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00020}00020 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00021}00021 \textcolor{comment}{//\#define STBVOX\_CONFIG\_TEX1\_EDGE\_CLAMP}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00022}00022 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00023}00023 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00024}00024 \textcolor{comment}{// currently no dynamic way to set mesh cache size or view distance}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00025}00025 \textcolor{comment}{//\#define SHORTVIEW}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00026}00026 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00027}00027 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00028}00028 \mbox{\hyperlink{structstbvox__mesh__maker}{stbvox\_mesh\_maker}} g\_mesh\_maker;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00029}00029 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00030}00030 GLuint main\_prog;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00031}00031 GLint uniform\_locations[64];}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00032}00032 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00033}00033 \textcolor{comment}{//\#define MAX\_QUADS\_PER\_DRAW        (65536 / 4) // assuming 16-\/bit indices, 4 verts per quad}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00034}00034 \textcolor{comment}{//\#define FIXED\_INDEX\_BUFFER\_SIZE   (MAX\_QUADS\_PER\_DRAW * 6 * 2)  // 16*1024 * 12 == \string~192KB}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00035}00035 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00036}00036 \textcolor{comment}{// while uploading texture data, this holds our each texture}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00037}00037 \textcolor{preprocessor}{\#define TEX\_SIZE  64}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00038}00038 uint32 texture[TEX\_SIZE][TEX\_SIZE];}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00039}00039 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00040}00040 GLuint voxel\_tex[2];}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00041}00041 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00042}00042 \textcolor{comment}{// chunk state}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00043}00043 \textcolor{keyword}{enum}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00044}00044 \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00045}00045    STATE\_invalid,}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00046}00046    STATE\_needed,}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00047}00047    STATE\_requested,}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00048}00048    STATE\_abandoned,}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00049}00049    STATE\_valid,}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00050}00050 \};}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00051}00051 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00052}00052 \textcolor{comment}{// mesh is 32x32x255 ... this is hardcoded in that}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00053}00053 \textcolor{comment}{// a mesh covers 2x2 minecraft chunks, no \#defines for it}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00054}\mbox{\hyperlink{structchunk__mesh}{00054}} \textcolor{keyword}{typedef} \textcolor{keyword}{struct}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00055}00055 \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00056}00056    \textcolor{keywordtype}{int} state;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00057}00057    \textcolor{keywordtype}{int} chunk\_x, chunk\_y;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00058}00058    \textcolor{keywordtype}{int} num\_quads;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00059}00059    \textcolor{keywordtype}{float} priority;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00060}00060    \textcolor{keywordtype}{int} vbuf\_size, fbuf\_size;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00061}00061 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00062}00062    \textcolor{keywordtype}{float} transform[3][3];}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00063}00063    \textcolor{keywordtype}{float} bounds[2][3];}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00064}00064 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00065}00065    GLuint vbuf;\textcolor{comment}{// vbuf\_tex;}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00066}00066    GLuint fbuf, fbuf\_tex;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00067}00067 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00068}00068 \} \mbox{\hyperlink{structchunk__mesh}{chunk\_mesh}};}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00069}00069 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00070}00070 \textcolor{keywordtype}{void} scale\_texture(\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} *src, \textcolor{keywordtype}{int} x, \textcolor{keywordtype}{int} y, \textcolor{keywordtype}{int} w, \textcolor{keywordtype}{int} h)}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00071}00071 \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00072}00072    \textcolor{keywordtype}{int} i,j,k;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00073}00073    assert(w == 256 \&\& h == 256);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00074}00074    \textcolor{keywordflow}{for} (j=0; j < TEX\_SIZE; ++j) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00075}00075       \textcolor{keywordflow}{for} (i=0; i < TEX\_SIZE; ++i) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00076}00076          uint32 val=0;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00077}00077          \textcolor{keywordflow}{for} (k=0; k < 4; ++k) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00078}00078             val >>= 8;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00079}00079             val += src[ 4*(x+(i>>2)) + 4*w*(y+(j>>2)) + k]<<24;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00080}00080          \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00081}00081          texture[j][i] = val;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00082}00082       \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00083}00083    \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00084}00084 \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00085}00085 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00086}00086 \textcolor{keywordtype}{void} build\_base\_texture(\textcolor{keywordtype}{int} n)}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00087}00087 \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00088}00088    \textcolor{keywordtype}{int} x,y;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00089}00089    uint32 color = stb\_rand() | 0x808080;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00090}00090    \textcolor{keywordflow}{for} (y=0; y<TEX\_SIZE; ++y)}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00091}00091       \textcolor{keywordflow}{for} (x=0; x<TEX\_SIZE; ++x) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00092}00092          texture[y][x] = (color + (stb\_rand()\&0x1f1f1f))|0xff000000;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00093}00093       \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00094}00094 \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00095}00095 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00096}00096 \textcolor{keywordtype}{void} build\_overlay\_texture(\textcolor{keywordtype}{int} n)}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00097}00097 \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00098}00098    \textcolor{keywordtype}{int} x,y;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00099}00099    uint32 color = stb\_rand();}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00100}00100    \textcolor{keywordflow}{if} (color \& 16)}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00101}00101       color = 0xff000000;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00102}00102    \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00103}00103       color = 0xffffffff;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00104}00104    \textcolor{keywordflow}{for} (y=0; y<TEX\_SIZE; ++y)}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00105}00105       \textcolor{keywordflow}{for} (x=0; x<TEX\_SIZE; ++x) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00106}00106          texture[y][x] = 0;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00107}00107       \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00108}00108 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00109}00109    \textcolor{keywordflow}{for} (y=0; y < TEX\_SIZE/8; ++y) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00110}00110       \textcolor{keywordflow}{for} (x=0; x < TEX\_SIZE; ++x) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00111}00111          texture[y][x] = color;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00112}00112          texture[TEX\_SIZE-\/1-\/y][x] = color;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00113}00113          texture[x][y] = color;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00114}00114          texture[x][TEX\_SIZE-\/1-\/y] = color;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00115}00115       \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00116}00116    \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00117}00117 \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00118}00118 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00119}00119 \textcolor{comment}{// view radius of about 1024 = 2048 columns / 32 columns-\/per-\/mesh = 2\string^11 / 2\string^5 = 64x64}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00120}00120 \textcolor{comment}{// so we need bigger than 64x64 so we can precache, which means we have to be}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00121}00121 \textcolor{comment}{// non-\/power-\/of-\/two, or we have to be pretty huge}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00122}00122 \textcolor{preprocessor}{\#define CACHED\_MESH\_NUM\_X   128}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00123}00123 \textcolor{preprocessor}{\#define CACHED\_MESH\_NUM\_Y   128}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00124}00124 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00125}00125 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00126}00126 \mbox{\hyperlink{structchunk__mesh}{chunk\_mesh}} cached\_chunk\_mesh[CACHED\_MESH\_NUM\_Y][CACHED\_MESH\_NUM\_X];}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00127}00127 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00128}00128 \textcolor{keywordtype}{void} free\_chunk(\textcolor{keywordtype}{int} slot\_x, \textcolor{keywordtype}{int} slot\_y)}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00129}00129 \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00130}00130    \mbox{\hyperlink{structchunk__mesh}{chunk\_mesh}} *cm = \&cached\_chunk\_mesh[slot\_y][slot\_x];}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00131}00131    \textcolor{keywordflow}{if} (cm-\/>state == STATE\_valid) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00132}00132       glDeleteTextures(1, \&cm-\/>fbuf\_tex);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00133}00133       glDeleteBuffersARB(1, \&cm-\/>vbuf);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00134}00134       glDeleteBuffersARB(1, \&cm-\/>fbuf);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00135}00135       cached\_chunk\_mesh[slot\_y][slot\_x].state = STATE\_invalid;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00136}00136    \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00137}00137 \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00138}00138 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00139}00139 \textcolor{keywordtype}{void} upload\_mesh(\mbox{\hyperlink{structchunk__mesh}{chunk\_mesh}} *cm, uint8 *build\_buffer, uint8 *face\_buffer)}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00140}00140 \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00141}00141    glGenBuffersARB(1, \&cm-\/>vbuf);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00142}00142    glBindBufferARB(GL\_ARRAY\_BUFFER\_ARB, cm-\/>vbuf);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00143}00143    glBufferDataARB(GL\_ARRAY\_BUFFER\_ARB, cm-\/>num\_quads*4*\textcolor{keyword}{sizeof}(uint32), build\_buffer, GL\_STATIC\_DRAW\_ARB);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00144}00144    glBindBufferARB(GL\_ARRAY\_BUFFER\_ARB, 0);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00145}00145 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00146}00146    glGenBuffersARB(1, \&cm-\/>fbuf);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00147}00147    glBindBufferARB(GL\_TEXTURE\_BUFFER\_ARB, cm-\/>fbuf);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00148}00148    glBufferDataARB(GL\_TEXTURE\_BUFFER\_ARB, cm-\/>num\_quads*\textcolor{keyword}{sizeof}(uint32), face\_buffer , GL\_STATIC\_DRAW\_ARB);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00149}00149    glBindBufferARB(GL\_TEXTURE\_BUFFER\_ARB, 0);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00150}00150 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00151}00151    glGenTextures(1, \&cm-\/>fbuf\_tex);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00152}00152    glBindTexture(GL\_TEXTURE\_BUFFER\_ARB, cm-\/>fbuf\_tex);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00153}00153    glTexBufferARB(GL\_TEXTURE\_BUFFER\_ARB, GL\_RGBA8UI, cm-\/>fbuf);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00154}00154    glBindTexture(GL\_TEXTURE\_BUFFER\_ARB, 0);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00155}00155 \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00156}00156 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00157}00157 \textcolor{keyword}{static} \textcolor{keywordtype}{void} upload\_mesh\_data(\mbox{\hyperlink{structraw__mesh}{raw\_mesh}} *rm)}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00158}00158 \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00159}00159    \textcolor{keywordtype}{int} cx = rm-\/>cx;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00160}00160    \textcolor{keywordtype}{int} cy = rm-\/>cy;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00161}00161    \textcolor{keywordtype}{int} slot\_x = (cx >> 1) \& (CACHED\_MESH\_NUM\_X-\/1);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00162}00162    \textcolor{keywordtype}{int} slot\_y = (cy >> 1) \& (CACHED\_MESH\_NUM\_Y-\/1);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00163}00163    \mbox{\hyperlink{structchunk__mesh}{chunk\_mesh}} *cm;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00164}00164 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00165}00165    free\_chunk(slot\_x, slot\_y);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00166}00166 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00167}00167    cm = \&cached\_chunk\_mesh[slot\_y][slot\_x];}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00168}00168    cm-\/>num\_quads = rm-\/>num\_quads;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00169}00169 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00170}00170    upload\_mesh(cm, rm-\/>build\_buffer, rm-\/>face\_buffer);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00171}00171    cm-\/>vbuf\_size = rm-\/>num\_quads*4*\textcolor{keyword}{sizeof}(uint32);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00172}00172    cm-\/>fbuf\_size = rm-\/>num\_quads*\textcolor{keyword}{sizeof}(uint32);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00173}00173    cm-\/>priority = 100000;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00174}00174    cm-\/>chunk\_x = cx;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00175}00175    cm-\/>chunk\_y = cy;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00176}00176 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00177}00177    memcpy(cm-\/>bounds, rm-\/>bounds, \textcolor{keyword}{sizeof}(cm-\/>bounds));}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00178}00178    memcpy(cm-\/>transform, rm-\/>transform, \textcolor{keyword}{sizeof}(cm-\/>transform));}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00179}00179 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00180}00180    \textcolor{comment}{// write barrier here}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00181}00181    cm-\/>state = STATE\_valid;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00182}00182 \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00183}00183 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00184}00184 GLint uniform\_loc[16];}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00185}00185 \textcolor{keywordtype}{float} table3[128][3];}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00186}00186 \textcolor{keywordtype}{float} table4[64][4];}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00187}00187 GLint tablei[2];}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00188}00188 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00189}00189 \textcolor{keywordtype}{float} \mbox{\hyperlink{group__core__func__common_ga015a1261ff23e12650211aa872863cce}{step}}=0;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00190}00190 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00191}00191 \textcolor{preprocessor}{\#ifdef SHORTVIEW}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00192}00192 \textcolor{keywordtype}{int} view\_dist\_in\_chunks = 50;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00193}00193 \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00194}00194 \textcolor{keywordtype}{int} view\_dist\_in\_chunks = 80;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00195}00195 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00196}00196 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00197}00197 \textcolor{keywordtype}{void} setup\_uniforms(\textcolor{keywordtype}{float} pos[3])}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00198}00198 \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00199}00199    \textcolor{keywordtype}{int} i,j;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00200}00200    \mbox{\hyperlink{group__core__func__common_ga015a1261ff23e12650211aa872863cce}{step}} += 1.0f/60.0f;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00201}00201    \textcolor{keywordflow}{for} (i=0; i < STBVOX\_UNIFORM\_count; ++i) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00202}00202       \mbox{\hyperlink{structstbvox__uniform__info}{stbvox\_uniform\_info}} raw, *ui=\&raw;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00203}00203       stbvox\_get\_uniform\_info(\&raw, i);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00204}00204       uniform\_loc[i] = -\/1;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00205}00205 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00206}00206       \textcolor{keywordflow}{if} (i == STBVOX\_UNIFORM\_texscale || i == STBVOX\_UNIFORM\_texgen || i == STBVOX\_UNIFORM\_color\_table)}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00207}00207          \textcolor{keywordflow}{continue};}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00208}00208 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00209}00209       \textcolor{keywordflow}{if} (ui) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00210}00210          \textcolor{keywordtype}{void} *data = ui-\/>default\_value;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00211}00211          uniform\_loc[i] = stbgl\_find\_uniform(main\_prog, ui-\/>name);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00212}00212         \textcolor{keywordflow}{switch} (i) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00213}00213             \textcolor{keywordflow}{case} STBVOX\_UNIFORM\_face\_data:}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00214}00214                tablei[0] = 2;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00215}00215                data = tablei;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00216}00216                \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00217}00217 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00218}00218             \textcolor{keywordflow}{case} STBVOX\_UNIFORM\_tex\_array:}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00219}00219                glActiveTextureARB(GL\_TEXTURE0\_ARB);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00220}00220                glBindTexture(GL\_TEXTURE\_2D\_ARRAY\_EXT, voxel\_tex[0]);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00221}00221                glActiveTextureARB(GL\_TEXTURE1\_ARB);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00222}00222                glBindTexture(GL\_TEXTURE\_2D\_ARRAY\_EXT, voxel\_tex[1]);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00223}00223                glActiveTextureARB(GL\_TEXTURE0\_ARB);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00224}00224                tablei[0] = 0;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00225}00225                tablei[1] = 1;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00226}00226                data = tablei;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00227}00227                \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00228}00228 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00229}00229             \textcolor{keywordflow}{case} STBVOX\_UNIFORM\_color\_table:}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00230}00230                data = ui-\/>default\_value;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00231}00231                ((\textcolor{keywordtype}{float} *)data)[63*4+3] = 2.0f; \textcolor{comment}{// emissive}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00232}00232                \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00233}00233 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00234}00234             \textcolor{keywordflow}{case} STBVOX\_UNIFORM\_camera\_pos:}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00235}00235                data = table3[0];}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00236}00236                table3[0][0] = pos[0];}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00237}00237                table3[0][1] = pos[1];}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00238}00238                table3[0][2] = pos[2];}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00239}00239                table3[0][3] = stb\_max(0,(\textcolor{keywordtype}{float})\mbox{\hyperlink{group__core__func__trigonometric_ga3fcdcfa2d2ac38de9ba1885cd1c79414}{sin}}(\mbox{\hyperlink{group__core__func__common_ga015a1261ff23e12650211aa872863cce}{step}}*2)*0.125f);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00240}00240                \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00241}00241 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00242}00242             \textcolor{keywordflow}{case} STBVOX\_UNIFORM\_ambient: \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00243}00243                \textcolor{keywordtype}{float} bright = 1.0;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00244}00244                \textcolor{comment}{//float bright = 0.75;}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00245}00245                \textcolor{keywordtype}{float} amb[3][3];}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00246}00246 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00247}00247                \textcolor{comment}{// ambient direction is sky-\/colored upwards}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00248}00248                \textcolor{comment}{// "{}ambient"{} lighting is from above}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00249}00249                table4[0][0] =  0.3f;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00250}00250                table4[0][1] = -\/0.5f;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00251}00251                table4[0][2] =  0.9f;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00252}00252 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00253}00253                amb[1][0] = 0.3f; amb[1][1] = 0.3f; amb[1][2] = 0.3f; \textcolor{comment}{// dark-\/grey}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00254}00254                amb[2][0] = 1.0; amb[2][1] = 1.0; amb[2][2] = 1.0; \textcolor{comment}{// white}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00255}00255 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00256}00256                \textcolor{comment}{// convert so (table[1]*dot+table[2]) gives}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00257}00257                \textcolor{comment}{// above interpolation}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00258}00258                \textcolor{comment}{//     lerp((dot+1)/2, amb[1], amb[2])}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00259}00259                \textcolor{comment}{//     amb[1] + (amb[2] -\/ amb[1]) * (dot+1)/2}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00260}00260                \textcolor{comment}{//     amb[1] + (amb[2] -\/ amb[1]) * dot/2 + (amb[2]-\/amb[1])/2}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00261}00261 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00262}00262                \textcolor{keywordflow}{for} (j=0; j < 3; ++j) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00263}00263                   table4[1][j] = (amb[2][j] -\/ amb[1][j])/2 * bright;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00264}00264                   table4[2][j] = (amb[1][j] + amb[2][j])/2 * bright;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00265}00265                \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00266}00266 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00267}00267                \textcolor{comment}{// fog color}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00268}00268                table4[3][0] = 0.6f, table4[3][1] = 0.7f, table4[3][2] = 0.9f;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00269}00269                table4[3][3] = 1.0f / (view\_dist\_in\_chunks * 16);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00270}00270                table4[3][3] *= table4[3][3];}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00271}00271 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00272}00272                data = table4;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00273}00273                \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00274}00274             \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00275}00275          \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00276}00276 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00277}00277          \textcolor{keywordflow}{switch} (ui-\/>type) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00278}00278             \textcolor{keywordflow}{case} STBVOX\_UNIFORM\_TYPE\_sampler: stbglUniform1iv(uniform\_loc[i], ui-\/>array\_length, data); \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00279}00279             \textcolor{keywordflow}{case} STBVOX\_UNIFORM\_TYPE\_vec2:    stbglUniform2fv(uniform\_loc[i], ui-\/>array\_length, data); \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00280}00280             \textcolor{keywordflow}{case} STBVOX\_UNIFORM\_TYPE\_vec3:    stbglUniform3fv(uniform\_loc[i], ui-\/>array\_length, data); \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00281}00281             \textcolor{keywordflow}{case} STBVOX\_UNIFORM\_TYPE\_vec4:    stbglUniform4fv(uniform\_loc[i], ui-\/>array\_length, data); \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00282}00282          \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00283}00283       \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00284}00284    \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00285}00285 \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00286}00286 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00287}00287 GLuint unitex[64], unibuf[64];}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00288}00288 \textcolor{keywordtype}{void} make\_texture\_buffer\_for\_uniform(\textcolor{keywordtype}{int} uniform, \textcolor{keywordtype}{int} slot)}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00289}00289 \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00290}00290    GLenum type;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00291}00291    \mbox{\hyperlink{structstbvox__uniform__info}{stbvox\_uniform\_info}} raw, *ui=\&raw;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00292}00292    GLint uloc;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00293}00293    }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00294}00294    stbvox\_get\_uniform\_info(ui, uniform);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00295}00295    uloc = stbgl\_find\_uniform(main\_prog, ui-\/>name);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00296}00296 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00297}00297    \textcolor{keywordflow}{if} (uniform == STBVOX\_UNIFORM\_color\_table)}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00298}00298       ((\textcolor{keywordtype}{float} *)ui-\/>default\_value)[63*4+3] = 2.0f; \textcolor{comment}{// emissive}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00299}00299 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00300}00300    glGenBuffersARB(1, \&unibuf[uniform]);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00301}00301    glBindBufferARB(GL\_ARRAY\_BUFFER\_ARB, unibuf[uniform]);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00302}00302    glBufferDataARB(GL\_ARRAY\_BUFFER\_ARB, ui-\/>array\_length * ui-\/>bytes\_per\_element, ui-\/>default\_value, GL\_STATIC\_DRAW\_ARB);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00303}00303    glBindBufferARB(GL\_ARRAY\_BUFFER\_ARB, 0);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00304}00304 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00305}00305    glGenTextures(1, \&unitex[uniform]);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00306}00306    glBindTexture(GL\_TEXTURE\_BUFFER\_ARB, unitex[uniform]);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00307}00307    \textcolor{keywordflow}{switch} (ui-\/>type) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00308}00308       \textcolor{keywordflow}{case} STBVOX\_UNIFORM\_TYPE\_vec2: type = GL\_RG32F; \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00309}00309       \textcolor{keywordflow}{case} STBVOX\_UNIFORM\_TYPE\_vec3: type = GL\_RGB32F; \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00310}00310       \textcolor{keywordflow}{case} STBVOX\_UNIFORM\_TYPE\_vec4: type = GL\_RGBA32F; \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00311}00311       \textcolor{keywordflow}{default}: assert(0);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00312}00312    \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00313}00313    glTexBufferARB(GL\_TEXTURE\_BUFFER\_ARB, type, unibuf[uniform]);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00314}00314    glBindTexture(GL\_TEXTURE\_BUFFER\_ARB, 0);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00315}00315 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00316}00316    glActiveTextureARB(GL\_TEXTURE0 + slot);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00317}00317    glBindTexture(GL\_TEXTURE\_BUFFER\_ARB, unitex[uniform]);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00318}00318    glActiveTextureARB(GL\_TEXTURE0);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00319}00319 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00320}00320    stbglUseProgram(main\_prog);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00321}00321    stbglUniform1i(uloc, slot);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00322}00322 \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00323}00323 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00324}00324 \textcolor{preprocessor}{\#define MAX\_MESH\_WORKERS  8}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00325}00325 \textcolor{preprocessor}{\#define MAX\_CHUNK\_LOAD\_WORKERS 2}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00326}00326 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00327}00327 \textcolor{keywordtype}{int} num\_mesh\_workers;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00328}00328 \textcolor{keywordtype}{int} num\_chunk\_load\_workers;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00329}00329 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00330}\mbox{\hyperlink{structmesh__worker}{00330}} \textcolor{keyword}{typedef} \textcolor{keyword}{struct}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00331}00331 \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00332}00332    \textcolor{keywordtype}{int} state;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00333}00333    \textcolor{keywordtype}{int} request\_cx;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00334}00334    \textcolor{keywordtype}{int} request\_cy;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00335}00335    \textcolor{keywordtype}{int} padding[13];}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00336}00336 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00337}00337    SDL\_sem * request\_received;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00338}00338 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00339}00339    SDL\_sem * chunk\_server\_done\_processing;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00340}00340    \textcolor{keywordtype}{int} chunk\_action;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00341}00341    \textcolor{keywordtype}{int} chunk\_request\_x;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00342}00342    \textcolor{keywordtype}{int} chunk\_request\_y;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00343}00343    \mbox{\hyperlink{structfast__chunk}{fast\_chunk}} *chunks[4][4];}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00344}00344 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00345}00345    \textcolor{keywordtype}{int} padding2[16];}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00346}00346    \mbox{\hyperlink{structraw__mesh}{raw\_mesh}} rm;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00347}00347    \textcolor{keywordtype}{int} padding3[16];}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00348}00348 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00349}00349    uint8 *build\_buffer;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00350}00350    uint8 *face\_buffer ;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00351}00351 \} \mbox{\hyperlink{structmesh__worker}{mesh\_worker}};}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00352}00352 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00353}00353 \textcolor{keyword}{enum}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00354}00354 \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00355}00355    WSTATE\_idle,}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00356}00356    WSTATE\_requested,}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00357}00357    WSTATE\_running,}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00358}00358    WSTATE\_mesh\_ready,}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00359}00359 \};}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00360}00360 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00361}00361 \mbox{\hyperlink{structmesh__worker}{mesh\_worker}} mesh\_data[MAX\_MESH\_WORKERS];}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00362}00362 \textcolor{keywordtype}{int} num\_meshes\_started; \textcolor{comment}{// stats}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00363}00363 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00364}00364 \textcolor{keywordtype}{int} request\_chunk(\textcolor{keywordtype}{int} chunk\_x, \textcolor{keywordtype}{int} chunk\_y);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00365}00365 \textcolor{keywordtype}{void} update\_meshes\_from\_render\_thread(\textcolor{keywordtype}{void});}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00366}00366 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00367}00367 \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} tex2\_data[64][4];}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00368}00368 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00369}00369 \textcolor{keywordtype}{void} init\_tex2\_gradient(\textcolor{keywordtype}{void})}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00370}00370 \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00371}00371    \textcolor{keywordtype}{int} i;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00372}00372    \textcolor{keywordflow}{for} (i=0; i < 16; ++i) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00373}00373       tex2\_data[i+ 0][0] = 64 + 12*i;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00374}00374       tex2\_data[i+ 0][1] = 32;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00375}00375       tex2\_data[i+ 0][2] = 64;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00376}00376 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00377}00377       tex2\_data[i+16][0] = 255;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00378}00378       tex2\_data[i+16][1] = 32 + 8*i;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00379}00379       tex2\_data[i+16][2] = 64;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00380}00380 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00381}00381       tex2\_data[i+32][0] = 255;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00382}00382       tex2\_data[i+32][1] = 160;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00383}00383       tex2\_data[i+32][2] = 64 + 12*i;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00384}00384 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00385}00385       tex2\_data[i+48][0] = 255;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00386}00386       tex2\_data[i+48][1] = 160 + 6*i;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00387}00387       tex2\_data[i+48][2] = 255;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00388}00388    \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00389}00389 \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00390}00390 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00391}00391 \textcolor{keywordtype}{void} set\_tex2\_alpha(\textcolor{keywordtype}{float} fa)}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00392}00392 \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00393}00393    \textcolor{keywordtype}{int} i;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00394}00394    \textcolor{keywordtype}{int} a = (int) stb\_lerp(fa, 0, 255);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00395}00395    \textcolor{keywordflow}{if} (a < 0) a = 0; \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (a > 255) a = 255;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00396}00396    glBindTexture(GL\_TEXTURE\_2D\_ARRAY\_EXT, voxel\_tex[1]);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00397}00397    \textcolor{keywordflow}{for} (i=0; i < 64; ++i) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00398}00398       tex2\_data[i][3] = a;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00399}00399       glTexSubImage3DEXT(GL\_TEXTURE\_2D\_ARRAY\_EXT, 0, 0,0,i, 1,1,1, GL\_RGBA, GL\_UNSIGNED\_BYTE, tex2\_data[i]);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00400}00400    \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00401}00401 \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00402}00402 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00403}00403 \textcolor{keywordtype}{void} render\_init(\textcolor{keywordtype}{void})}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00404}00404 \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00405}00405    \textcolor{keywordtype}{int} i;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00406}00406    \textcolor{keywordtype}{char} *binds[] = \{ \textcolor{stringliteral}{"{}attr\_vertex"{}}, \textcolor{stringliteral}{"{}attr\_face"{}}, NULL \};}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00407}00407    \textcolor{keywordtype}{char} *vertex;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00408}00408    \textcolor{keywordtype}{char} *fragment;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00409}00409    \textcolor{keywordtype}{int} w=0,h=0;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00410}00410 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00411}00411    \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} *texdata = stbi\_load(\textcolor{stringliteral}{"{}terrain.png"{}}, \&w, \&h, NULL, 4);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00412}00412 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00413}00413    stbvox\_init\_mesh\_maker(\&g\_mesh\_maker);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00414}00414    \textcolor{keywordflow}{for} (i=0; i < num\_mesh\_workers; ++i) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00415}00415       stbvox\_init\_mesh\_maker(\&mesh\_data[i].rm.mm);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00416}00416    \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00417}00417 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00418}00418    vertex = stbvox\_get\_vertex\_shader();}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00419}00419    fragment = stbvox\_get\_fragment\_shader();}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00420}00420 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00421}00421    \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00422}00422       \textcolor{keywordtype}{char} error\_buffer[1024];}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00423}00423       \textcolor{keywordtype}{char} *main\_vertex[] = \{ vertex, NULL \};}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00424}00424       \textcolor{keywordtype}{char} *main\_fragment[] = \{ fragment, NULL \};}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00425}00425       main\_prog = stbgl\_create\_program(main\_vertex, main\_fragment, binds, error\_buffer, \textcolor{keyword}{sizeof}(error\_buffer));}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00426}00426       \textcolor{keywordflow}{if} (main\_prog == 0) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00427}00427          ods(\textcolor{stringliteral}{"{}Compile error for main shader: \%s\(\backslash\)n"{}}, error\_buffer);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00428}00428          assert(0);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00429}00429          exit(1);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00430}00430       \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00431}00431    \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00432}00432    \textcolor{comment}{//init\_index\_buffer();}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00433}00433 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00434}00434    make\_texture\_buffer\_for\_uniform(STBVOX\_UNIFORM\_texscale     , 3);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00435}00435    make\_texture\_buffer\_for\_uniform(STBVOX\_UNIFORM\_texgen       , 4);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00436}00436    make\_texture\_buffer\_for\_uniform(STBVOX\_UNIFORM\_color\_table  , 5);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00437}00437 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00438}00438    glGenTextures(2, voxel\_tex);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00439}00439 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00440}00440    glBindTexture(GL\_TEXTURE\_2D\_ARRAY\_EXT, voxel\_tex[0]);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00441}00441    glTexImage3DEXT(GL\_TEXTURE\_2D\_ARRAY\_EXT, 0, GL\_RGBA,}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00442}00442                       TEX\_SIZE,TEX\_SIZE,256,}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00443}00443                       0,GL\_RGBA,GL\_UNSIGNED\_BYTE,NULL);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00444}00444    \textcolor{keywordflow}{for} (i=0; i < 256; ++i) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00445}00445       \textcolor{keywordflow}{if} (texdata)}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00446}00446          scale\_texture(texdata, (i\&15)*w/16, (h/16)*(i>>4), w,h);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00447}00447       \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00448}00448          build\_base\_texture(i);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00449}00449       glTexSubImage3DEXT(GL\_TEXTURE\_2D\_ARRAY\_EXT, 0, 0,0,i, TEX\_SIZE,TEX\_SIZE,1, GL\_RGBA, GL\_UNSIGNED\_BYTE, texture[0]);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00450}00450    \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00451}00451    glTexParameteri(GL\_TEXTURE\_2D\_ARRAY\_EXT, GL\_TEXTURE\_MIN\_FILTER, GL\_LINEAR\_MIPMAP\_LINEAR);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00452}00452    glTexParameteri(GL\_TEXTURE\_2D\_ARRAY\_EXT, GL\_TEXTURE\_MAG\_FILTER, GL\_LINEAR);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00453}00453    glTexParameteri(GL\_TEXTURE\_2D\_ARRAY\_EXT, GL\_TEXTURE\_MAX\_ANISOTROPY\_EXT, 16);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00454}00454 \textcolor{preprocessor}{   \#ifdef STBVOX\_CONFIG\_TEX1\_EDGE\_CLAMP}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00455}00455    glTexParameteri(GL\_TEXTURE\_2D\_ARRAY\_EXT, GL\_TEXTURE\_WRAP\_S, GL\_CLAMP\_TO\_EDGE);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00456}00456    glTexParameteri(GL\_TEXTURE\_2D\_ARRAY\_EXT, GL\_TEXTURE\_WRAP\_T, GL\_CLAMP\_TO\_EDGE);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00457}00457 \textcolor{preprocessor}{   \#endif}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00458}00458 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00459}00459    glGenerateMipmapEXT(GL\_TEXTURE\_2D\_ARRAY\_EXT);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00460}00460 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00461}00461    glBindTexture(GL\_TEXTURE\_2D\_ARRAY\_EXT, voxel\_tex[1]);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00462}00462    glTexImage3DEXT(GL\_TEXTURE\_2D\_ARRAY\_EXT, 0, GL\_RGBA,}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00463}00463                       1,1,64,}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00464}00464                       0,GL\_RGBA,GL\_UNSIGNED\_BYTE,NULL);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00465}00465    init\_tex2\_gradient();}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00466}00466    set\_tex2\_alpha(0.0);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00467}00467 \textcolor{preprocessor}{   \#if 0}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00468}00468    \textcolor{keywordflow}{for} (i=0; i < 128; ++i) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00469}00469       \textcolor{comment}{//build\_overlay\_texture(i);}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00470}00470       glTexSubImage3DEXT(GL\_TEXTURE\_2D\_ARRAY\_EXT, 0, 0,0,i, TEX\_SIZE,TEX\_SIZE,1, GL\_RGBA, GL\_UNSIGNED\_BYTE, texture[0]);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00471}00471    \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00472}00472 \textcolor{preprocessor}{   \#endif}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00473}00473    glTexParameteri(GL\_TEXTURE\_2D\_ARRAY\_EXT, GL\_TEXTURE\_MIN\_FILTER, GL\_LINEAR\_MIPMAP\_LINEAR);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00474}00474    glTexParameteri(GL\_TEXTURE\_2D\_ARRAY\_EXT, GL\_TEXTURE\_MAG\_FILTER, GL\_LINEAR);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00475}00475    glGenerateMipmapEXT(GL\_TEXTURE\_2D\_ARRAY\_EXT);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00476}00476 \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00477}00477 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00478}00478 \textcolor{keywordtype}{void} world\_init(\textcolor{keywordtype}{void})}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00479}00479 \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00480}00480    \textcolor{keywordtype}{int} a,b,x,y;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00481}00481 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00482}00482    Uint64 start\_time, end\_time;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00483}00483 \textcolor{preprocessor}{   \#ifdef NDEBUG}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00484}00484    \textcolor{keywordtype}{int} range = 32;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00485}00485 \textcolor{preprocessor}{   \#else}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00486}00486    \textcolor{keywordtype}{int} range = 12;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00487}00487 \textcolor{preprocessor}{   \#endif}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00488}00488 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00489}00489    start\_time = SDL\_GetPerformanceCounter();}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00490}00490 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00491}00491    \textcolor{comment}{// iterate in 8x8 clusters of qchunks at a time to get better converted-\/chunk-\/cache reuse}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00492}00492    \textcolor{comment}{// than a purely row-\/by-\/row ordering is (single-\/threaded this is a bigger win than}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00493}00493    \textcolor{comment}{// any of the above optimizations were, since it halves zlib/mc-\/conversion costs)}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00494}00494    \textcolor{keywordflow}{for} (x=-\/range; x <= range; x += 16)}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00495}00495       \textcolor{keywordflow}{for} (y=-\/range; y <= range; y += 16)}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00496}00496          \textcolor{keywordflow}{for} (b=y; b < y+16 \&\& b <= range; b += 2)}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00497}00497             \textcolor{keywordflow}{for} (a=x; a < x+16 \&\& a <= range; a += 2)}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00498}00498                \textcolor{keywordflow}{while} (!request\_chunk(a, b)) \{ \textcolor{comment}{// if request fails, all threads are busy}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00499}00499                   update\_meshes\_from\_render\_thread();}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00500}00500                   SDL\_Delay(1);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00501}00501                \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00502}00502 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00503}00503    \textcolor{comment}{// wait until all the workers are done,}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00504}00504    \textcolor{comment}{// (this is only needed if we want to time}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00505}00505    \textcolor{comment}{// when the build finishes, or when we want to reset the}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00506}00506    \textcolor{comment}{// cache size; otherwise we could just go ahead and}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00507}00507    \textcolor{comment}{// start rendering whatever we've got)}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00508}00508    \textcolor{keywordflow}{for}(;;) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00509}00509       \textcolor{keywordtype}{int} i;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00510}00510       update\_meshes\_from\_render\_thread();}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00511}00511       \textcolor{keywordflow}{for} (i=0; i < num\_mesh\_workers; ++i)}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00512}00512          \textcolor{keywordflow}{if} (mesh\_data[i].state != WSTATE\_idle)}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00513}00513             \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00514}00514       \textcolor{keywordflow}{if} (i == num\_mesh\_workers)}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00515}00515          \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00516}00516       SDL\_Delay(3);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00517}00517    \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00518}00518 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00519}00519    end\_time = SDL\_GetPerformanceCounter();}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00520}00520    ods(\textcolor{stringliteral}{"{}Build time: \%7.2fs\(\backslash\)n"{}}, (end\_time -\/ start\_time) / (\textcolor{keywordtype}{float}) SDL\_GetPerformanceFrequency());}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00521}00521 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00522}00522    \textcolor{comment}{// don't waste lots of storage on chunk caches once it's finished starting-\/up;}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00523}00523    \textcolor{comment}{// this was only needed to be this large because we worked in large blocks}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00524}00524    \textcolor{comment}{// to maximize sharing}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00525}00525    reset\_cache\_size(32);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00526}00526 \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00527}00527 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00528}00528 \textcolor{keyword}{extern} SDL\_mutex * chunk\_cache\_mutex;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00529}00529 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00530}00530 \textcolor{keywordtype}{int} mesh\_worker\_handler(\textcolor{keywordtype}{void} *data)}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00531}00531 \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00532}00532    \mbox{\hyperlink{structmesh__worker}{mesh\_worker}} *mw = data;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00533}00533    mw-\/>face\_buffer = malloc(FACE\_BUFFER\_SIZE);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00534}00534    mw-\/>build\_buffer = malloc(BUILD\_BUFFER\_SIZE);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00535}00535 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00536}00536    \textcolor{comment}{// this loop only works because the compiler can't}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00537}00537    \textcolor{comment}{// tell that the SDL\_calls don't access mw-\/>state;}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00538}00538    \textcolor{comment}{// really we should barrier that stuff}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00539}00539    \textcolor{keywordflow}{for}(;;) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00540}00540       \textcolor{keywordtype}{int} i,j;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00541}00541       \textcolor{keywordtype}{int} cx,cy;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00542}00542 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00543}00543       \textcolor{comment}{// wait for a chunk request}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00544}00544       SDL\_SemWait(mw-\/>request\_received);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00545}00545 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00546}00546       \textcolor{comment}{// analyze the chunk request}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00547}00547       assert(mw-\/>state == WSTATE\_requested);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00548}00548       cx = mw-\/>request\_cx;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00549}00549       cy = mw-\/>request\_cy;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00550}00550 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00551}00551       \textcolor{comment}{// this is inaccurate as it can block while another thread has the cache locked}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00552}00552       mw-\/>state = WSTATE\_running;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00553}00553 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00554}00554       \textcolor{comment}{// get the chunks we need (this takes a lock and caches them)}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00555}00555       \textcolor{keywordflow}{for} (j=0; j < 4; ++j)}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00556}00556          \textcolor{keywordflow}{for} (i=0; i < 4; ++i)}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00557}00557             mw-\/>chunks[j][i] = get\_converted\_fastchunk(cx-\/1 + i, cy-\/1 + j);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00558}00558 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00559}00559       \textcolor{comment}{// build the mesh based on the chunks}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00560}00560       mw-\/>rm.build\_buffer = mw-\/>build\_buffer;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00561}00561       mw-\/>rm.face\_buffer = mw-\/>face\_buffer;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00562}00562       build\_chunk(cx, cy, mw-\/>chunks, \&mw-\/>rm);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00563}00563       mw-\/>state = WSTATE\_mesh\_ready;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00564}00564       \textcolor{comment}{// don't need to notify of this, because it gets polled}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00565}00565 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00566}00566       \textcolor{comment}{// when done, free the chunks}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00567}00567 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00568}00568       \textcolor{comment}{// for efficiency we just take the mutex once around the whole thing,}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00569}00569       \textcolor{comment}{// though this spreads the mutex logic over two files}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00570}00570       SDL\_LockMutex(chunk\_cache\_mutex);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00571}00571       \textcolor{keywordflow}{for} (j=0; j < 4; ++j)}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00572}00572          \textcolor{keywordflow}{for} (i=0; i < 4; ++i) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00573}00573             deref\_fastchunk(mw-\/>chunks[j][i]);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00574}00574             mw-\/>chunks[j][i] = NULL;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00575}00575          \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00576}00576       SDL\_UnlockMutex(chunk\_cache\_mutex);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00577}00577    \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00578}00578    \textcolor{keywordflow}{return} 0;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00579}00579 \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00580}00580 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00581}00581 \textcolor{keywordtype}{int} request\_chunk(\textcolor{keywordtype}{int} chunk\_x, \textcolor{keywordtype}{int} chunk\_y)}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00582}00582 \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00583}00583    \textcolor{keywordtype}{int} i;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00584}00584    \textcolor{keywordflow}{for} (i=0; i < num\_mesh\_workers; ++i) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00585}00585       \mbox{\hyperlink{structmesh__worker}{mesh\_worker}} *mw = \&mesh\_data[i];}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00586}00586       \textcolor{keywordflow}{if} (mw-\/>state == WSTATE\_idle) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00587}00587          mw-\/>request\_cx = chunk\_x;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00588}00588          mw-\/>request\_cy = chunk\_y;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00589}00589          mw-\/>state = WSTATE\_requested;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00590}00590          SDL\_SemPost(mw-\/>request\_received);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00591}00591          ++num\_meshes\_started;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00592}00592          \textcolor{keywordflow}{return} 1;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00593}00593       \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00594}00594    \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00595}00595    \textcolor{keywordflow}{return} 0;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00596}00596 \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00597}00597 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00598}00598 \textcolor{keywordtype}{void} prepare\_threads(\textcolor{keywordtype}{void})}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00599}00599 \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00600}00600    \textcolor{keywordtype}{int} i;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00601}00601    \textcolor{keywordtype}{int} num\_proc = SDL\_GetCPUCount();}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00602}00602 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00603}00603    \textcolor{keywordflow}{if} (num\_proc > 6)}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00604}00604       num\_mesh\_workers = num\_proc/2;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00605}00605    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (num\_proc > 4)}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00606}00606       num\_mesh\_workers = 4;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00607}00607    \textcolor{keywordflow}{else} }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00608}00608       num\_mesh\_workers = num\_proc-\/1;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00609}00609 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00610}00610 \textcolor{comment}{// @TODO}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00611}00611 \textcolor{comment}{//   Thread usage is probably pretty terrible; need to make a}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00612}00612 \textcolor{comment}{//   separate queue of needed chunks, instead of just generating}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00613}00613 \textcolor{comment}{//   one request per thread per frame, and a separate queue of}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00614}00614 \textcolor{comment}{//   results. (E.g. If it takes 1.5 frames to build mesh, thread}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00615}00615 \textcolor{comment}{//   is idle for 0.5 frames.) To fake this for now, I've just}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00616}00616 \textcolor{comment}{//   doubled the number of threads to let those serve as a 'queue',}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00617}00617 \textcolor{comment}{//   but that's dumb.}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00618}00618 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00619}00619    num\_mesh\_workers *= 2; \textcolor{comment}{// try to get better thread usage}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00620}00620 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00621}00621    \textcolor{keywordflow}{if} (num\_mesh\_workers > MAX\_MESH\_WORKERS)}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00622}00622       num\_mesh\_workers = MAX\_MESH\_WORKERS;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00623}00623 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00624}00624    \textcolor{keywordflow}{for} (i=0; i < num\_mesh\_workers; ++i) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00625}00625       \mbox{\hyperlink{structmesh__worker}{mesh\_worker}} *data = \&mesh\_data[i];}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00626}00626       data-\/>request\_received = SDL\_CreateSemaphore(0);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00627}00627       data-\/>chunk\_server\_done\_processing = SDL\_CreateSemaphore(0);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00628}00628       SDL\_CreateThread(mesh\_worker\_handler, \textcolor{stringliteral}{"{}mesh worker"{}}, data);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00629}00629    \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00630}00630 \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00631}00631 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00632}00632 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00633}00633 \textcolor{comment}{// "{}better"{} buffer uploading}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00634}00634 \textcolor{preprocessor}{\#if 0}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00635}00635    \textcolor{keywordflow}{if} (glBufferStorage) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00636}00636       glDeleteBuffersARB(1, \&vb-\/>vbuf);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00637}00637       glGenBuffersARB(1, \&vb-\/>vbuf);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00638}00638 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00639}00639       glBindBufferARB(GL\_ARRAY\_BUFFER\_ARB, vb-\/>vbuf);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00640}00640       glBufferStorage(GL\_ARRAY\_BUFFER\_ARB, \textcolor{keyword}{sizeof}(build\_buffer), build\_buffer, 0);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00641}00641       glBindBufferARB(GL\_ARRAY\_BUFFER\_ARB, 0);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00642}00642    \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00643}00643       glBindBufferARB(GL\_ARRAY\_BUFFER\_ARB, vb-\/>vbuf);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00644}00644       glBufferDataARB(GL\_ARRAY\_BUFFER\_ARB, \textcolor{keyword}{sizeof}(build\_buffer), build\_buffer, GL\_STATIC\_DRAW\_ARB);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00645}00645       glBindBufferARB(GL\_ARRAY\_BUFFER\_ARB, 0);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00646}00646    \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00647}00647 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00648}00648 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00649}00649 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00650}\mbox{\hyperlink{structplane}{00650}} \textcolor{keyword}{typedef} \textcolor{keyword}{struct}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00651}00651 \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00652}00652    \textcolor{keywordtype}{float} x,y,z,w;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00653}00653 \} \mbox{\hyperlink{structplane}{plane}};}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00654}00654 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00655}00655 \textcolor{keyword}{static} \mbox{\hyperlink{structplane}{plane}} \mbox{\hyperlink{group__gtc__matrix__transform_gaf2b9bdfe77c910ce3ae07c1a386d110e}{frustum}}[6];}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00656}00656 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00657}00657 \textcolor{keyword}{static} \textcolor{keywordtype}{void} matd\_mul(\textcolor{keywordtype}{double} out[4][4], \textcolor{keywordtype}{double} src1[4][4], \textcolor{keywordtype}{double} src2[4][4])}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00658}00658 \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00659}00659    \textcolor{keywordtype}{int} i,j,k;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00660}00660    \textcolor{keywordflow}{for} (j=0; j < 4; ++j) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00661}00661       \textcolor{keywordflow}{for} (i=0; i < 4; ++i) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00662}00662          \textcolor{keywordtype}{double} t=0;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00663}00663          \textcolor{keywordflow}{for} (k=0; k < 4; ++k)}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00664}00664             t += src1[k][i] * src2[j][k];}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00665}00665          out[i][j] = t;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00666}00666       \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00667}00667    \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00668}00668 \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00669}00669 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00670}00670 \textcolor{comment}{// https://fgiesen.wordpress.com/2012/08/31/frustum-\/planes-\/from-\/the-\/projection-\/matrix/}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00671}00671 \textcolor{keyword}{static} \textcolor{keywordtype}{void} compute\_frustum(\textcolor{keywordtype}{void})}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00672}00672 \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00673}00673    \textcolor{keywordtype}{int} i;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00674}00674    GLdouble mv[4][4],\mbox{\hyperlink{group__gtx__projection_ga58384b7170801dd513de46f87c7fb00e}{proj}}[4][4], mvproj[4][4];}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00675}00675    glGetDoublev(GL\_MODELVIEW\_MATRIX , mv[0]);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00676}00676    glGetDoublev(GL\_PROJECTION\_MATRIX, \mbox{\hyperlink{group__gtx__projection_ga58384b7170801dd513de46f87c7fb00e}{proj}}[0]);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00677}00677    matd\_mul(mvproj, \mbox{\hyperlink{group__gtx__projection_ga58384b7170801dd513de46f87c7fb00e}{proj}}, mv);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00678}00678    \textcolor{keywordflow}{for} (i=0; i < 4; ++i) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00679}00679       (\&\mbox{\hyperlink{group__gtc__matrix__transform_gaf2b9bdfe77c910ce3ae07c1a386d110e}{frustum}}[0].x)[i] = (\textcolor{keywordtype}{float}) (mvproj[3][i] + mvproj[0][i]);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00680}00680       (\&\mbox{\hyperlink{group__gtc__matrix__transform_gaf2b9bdfe77c910ce3ae07c1a386d110e}{frustum}}[1].x)[i] = (\textcolor{keywordtype}{float}) (mvproj[3][i] -\/ mvproj[0][i]);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00681}00681       (\&\mbox{\hyperlink{group__gtc__matrix__transform_gaf2b9bdfe77c910ce3ae07c1a386d110e}{frustum}}[2].x)[i] = (\textcolor{keywordtype}{float}) (mvproj[3][i] + mvproj[1][i]);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00682}00682       (\&\mbox{\hyperlink{group__gtc__matrix__transform_gaf2b9bdfe77c910ce3ae07c1a386d110e}{frustum}}[3].x)[i] = (\textcolor{keywordtype}{float}) (mvproj[3][i] -\/ mvproj[1][i]);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00683}00683       (\&\mbox{\hyperlink{group__gtc__matrix__transform_gaf2b9bdfe77c910ce3ae07c1a386d110e}{frustum}}[4].x)[i] = (\textcolor{keywordtype}{float}) (mvproj[3][i] + mvproj[2][i]);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00684}00684       (\&\mbox{\hyperlink{group__gtc__matrix__transform_gaf2b9bdfe77c910ce3ae07c1a386d110e}{frustum}}[5].x)[i] = (\textcolor{keywordtype}{float}) (mvproj[3][i] -\/ mvproj[2][i]);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00685}00685    \}   }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00686}00686 \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00687}00687 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00688}00688 \textcolor{keyword}{static} \textcolor{keywordtype}{int} test\_plane(\mbox{\hyperlink{structplane}{plane}} *p, \textcolor{keywordtype}{float} x0, \textcolor{keywordtype}{float} y0, \textcolor{keywordtype}{float} z0, \textcolor{keywordtype}{float} x1, \textcolor{keywordtype}{float} y1, \textcolor{keywordtype}{float} z1)}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00689}00689 \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00690}00690    \textcolor{comment}{// return false if the box is entirely behind the plane}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00691}00691    \textcolor{keywordtype}{float} d=0;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00692}00692    assert(x0 <= x1 \&\& y0 <= y1 \&\& z0 <= z1);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00693}00693    \textcolor{keywordflow}{if} (p-\/>x > 0) d += x1*p-\/>x; \textcolor{keywordflow}{else} d += x0*p-\/>x;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00694}00694    \textcolor{keywordflow}{if} (p-\/>y > 0) d += y1*p-\/>y; \textcolor{keywordflow}{else} d += y0*p-\/>y;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00695}00695    \textcolor{keywordflow}{if} (p-\/>z > 0) d += z1*p-\/>z; \textcolor{keywordflow}{else} d += z0*p-\/>z;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00696}00696    \textcolor{keywordflow}{return} d + p-\/>w >= 0;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00697}00697 \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00698}00698 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00699}00699 \textcolor{keyword}{static} \textcolor{keywordtype}{int} is\_box\_in\_frustum(\textcolor{keywordtype}{float} *bmin, \textcolor{keywordtype}{float} *bmax)}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00700}00700 \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00701}00701    \textcolor{keywordtype}{int} i;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00702}00702    \textcolor{keywordflow}{for} (i=0; i < 6; ++i)}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00703}00703       \textcolor{keywordflow}{if} (!test\_plane(\&\mbox{\hyperlink{group__gtc__matrix__transform_gaf2b9bdfe77c910ce3ae07c1a386d110e}{frustum}}[i], bmin[0], bmin[1], bmin[2], bmax[0], bmax[1], bmax[2]))}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00704}00704          \textcolor{keywordflow}{return} 0;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00705}00705    \textcolor{keywordflow}{return} 1;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00706}00706 \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00707}00707 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00708}00708 \textcolor{keywordtype}{float} compute\_priority(\textcolor{keywordtype}{int} cx, \textcolor{keywordtype}{int} cy, \textcolor{keywordtype}{float} x, \textcolor{keywordtype}{float} y)}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00709}00709 \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00710}00710    \textcolor{keywordtype}{float} distx, disty, dist2;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00711}00711    distx = (cx*16+8) -\/ x;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00712}00712    disty = (cy*16+8) -\/ y;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00713}00713    dist2 = distx*distx + disty*disty;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00714}00714    \textcolor{keywordflow}{return} view\_dist\_in\_chunks*view\_dist\_in\_chunks * 16 * 16 -\/ dist2;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00715}00715 \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00716}00716 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00717}00717 \textcolor{keywordtype}{int} chunk\_locations, chunks\_considered, chunks\_in\_frustum;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00718}00718 \textcolor{keywordtype}{int} quads\_considered, quads\_rendered;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00719}00719 \textcolor{keywordtype}{int} chunk\_storage\_rendered, chunk\_storage\_considered, chunk\_storage\_total;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00720}00720 \textcolor{keywordtype}{int} update\_frustum = 1;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00721}00721 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00722}00722 \textcolor{preprocessor}{\#ifdef SHORTVIEW}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00723}00723 \textcolor{keywordtype}{int} max\_chunk\_storage = 450 << 20;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00724}00724 \textcolor{keywordtype}{int} min\_chunk\_storage = 350 << 20;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00725}00725 \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00726}00726 \textcolor{keywordtype}{int} max\_chunk\_storage = 900 << 20;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00727}00727 \textcolor{keywordtype}{int} min\_chunk\_storage = 800 << 20;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00728}00728 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00729}00729 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00730}00730 \textcolor{keywordtype}{float} min\_priority = -\/500; \textcolor{comment}{// this really wants to be in unit space, not squared space}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00731}00731 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00732}00732 \textcolor{keywordtype}{int} num\_meshes\_uploaded;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00733}00733 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00734}00734 \textcolor{keywordtype}{void} update\_meshes\_from\_render\_thread(\textcolor{keywordtype}{void})}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00735}00735 \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00736}00736    \textcolor{keywordtype}{int} i;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00737}00737    \textcolor{keywordflow}{for} (i=0; i < num\_mesh\_workers; ++i) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00738}00738       \mbox{\hyperlink{structmesh__worker}{mesh\_worker}} *mw = \&mesh\_data[i];}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00739}00739       \textcolor{keywordflow}{if} (mw-\/>state == WSTATE\_mesh\_ready) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00740}00740          upload\_mesh\_data(\&mw-\/>rm);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00741}00741          ++num\_meshes\_uploaded;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00742}00742          mw-\/>state = WSTATE\_idle;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00743}00743       \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00744}00744    \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00745}00745 \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00746}00746 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00747}00747 \textcolor{keyword}{extern} \textcolor{keywordtype}{float} tex2\_alpha;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00748}00748 \textcolor{keyword}{extern} \textcolor{keywordtype}{int} global\_hack;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00749}00749 \textcolor{keywordtype}{int} num\_threads\_active;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00750}00750 \textcolor{keywordtype}{float} chunk\_server\_activity;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00751}00751 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00752}00752 \textcolor{keywordtype}{void} render\_caves(\textcolor{keywordtype}{float} campos[3])}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00753}00753 \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00754}00754    \textcolor{keywordtype}{float} x = campos[0], y = campos[1];}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00755}00755    \textcolor{keywordtype}{int} qchunk\_x, qchunk\_y;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00756}00756    \textcolor{keywordtype}{int} cam\_x, cam\_y;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00757}00757    \textcolor{keywordtype}{int} i,j, rad;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00758}00758 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00759}00759    compute\_frustum();}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00760}00760 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00761}00761    chunk\_locations = chunks\_considered = chunks\_in\_frustum = 0;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00762}00762    quads\_considered = quads\_rendered = 0;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00763}00763    chunk\_storage\_total = chunk\_storage\_considered = chunk\_storage\_rendered = 0;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00764}00764 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00765}00765    cam\_x = (int) \mbox{\hyperlink{group__core__func__common_gac433646923ab80af6d9964f1570855d5}{floor}}(x+0.5);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00766}00766    cam\_y = (int) \mbox{\hyperlink{group__core__func__common_gac433646923ab80af6d9964f1570855d5}{floor}}(y+0.5);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00767}00767 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00768}00768    qchunk\_x = (((int) \mbox{\hyperlink{group__core__func__common_gac433646923ab80af6d9964f1570855d5}{floor}}(x)+16) >> 5) << 1;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00769}00769    qchunk\_y = (((int) \mbox{\hyperlink{group__core__func__common_gac433646923ab80af6d9964f1570855d5}{floor}}(y)+16) >> 5) << 1;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00770}00770 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00771}00771    glEnable(GL\_ALPHA\_TEST);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00772}00772    glAlphaFunc(GL\_GREATER, 0.5);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00773}00773 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00774}00774    stbglUseProgram(main\_prog);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00775}00775    setup\_uniforms(campos); \textcolor{comment}{// set uniforms to default values inefficiently}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00776}00776    glActiveTextureARB(GL\_TEXTURE2\_ARB);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00777}00777    stbglEnableVertexAttribArray(0);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00778}00778 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00779}00779    \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00780}00780       \textcolor{keywordtype}{float} lighting[2][3] = \{ \{ campos[0],campos[1],campos[2] \}, \{ 0.75,0.75,0.65f \} \};}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00781}00781       \textcolor{keywordtype}{float} bright = 8;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00782}00782       lighting[1][0] *= bright;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00783}00783       lighting[1][1] *= bright;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00784}00784       lighting[1][2] *= bright;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00785}00785       stbglUniform3fv(stbgl\_find\_uniform(main\_prog, \textcolor{stringliteral}{"{}light\_source"{}}), 2, lighting[0]);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00786}00786    \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00787}00787 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00788}00788    \textcolor{keywordflow}{if} (global\_hack)}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00789}00789       set\_tex2\_alpha(tex2\_alpha);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00790}00790 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00791}00791    num\_meshes\_uploaded = 0;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00792}00792    update\_meshes\_from\_render\_thread();}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00793}00793 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00794}00794    \textcolor{comment}{// traverse all in-\/range chunks and analyze them}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00795}00795    \textcolor{keywordflow}{for} (j=-\/view\_dist\_in\_chunks; j <= view\_dist\_in\_chunks; j += 2) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00796}00796       \textcolor{keywordflow}{for} (i=-\/view\_dist\_in\_chunks; i <= view\_dist\_in\_chunks; i += 2) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00797}00797          \textcolor{keywordtype}{float} priority;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00798}00798          \textcolor{keywordtype}{int} cx = qchunk\_x + i;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00799}00799          \textcolor{keywordtype}{int} cy = qchunk\_y + j;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00800}00800 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00801}00801          priority = compute\_priority(cx, cy, x, y);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00802}00802          \textcolor{keywordflow}{if} (priority >= min\_priority) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00803}00803             \textcolor{keywordtype}{int} slot\_x = (cx>>1) \& (CACHED\_MESH\_NUM\_X-\/1);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00804}00804             \textcolor{keywordtype}{int} slot\_y = (cy>>1) \& (CACHED\_MESH\_NUM\_Y-\/1);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00805}00805             \mbox{\hyperlink{structchunk__mesh}{chunk\_mesh}} *cm = \&cached\_chunk\_mesh[slot\_y][slot\_x];}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00806}00806             ++chunk\_locations;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00807}00807             \textcolor{keywordflow}{if} (cm-\/>state == STATE\_valid \&\& priority >= 0) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00808}00808                \textcolor{comment}{// check if chunk pos actually matches}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00809}00809                \textcolor{keywordflow}{if} (cm-\/>chunk\_x != cx || cm-\/>chunk\_y != cy) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00810}00810                   \textcolor{comment}{// we have a stale chunk we need to recreate}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00811}00811                   free\_chunk(slot\_x, slot\_y); \textcolor{comment}{// it probably will have already gotten freed, but just in case}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00812}00812                \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00813}00813             \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00814}00814             \textcolor{keywordflow}{if} (cm-\/>state == STATE\_invalid) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00815}00815                cm-\/>chunk\_x = cx;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00816}00816                cm-\/>chunk\_y = cy;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00817}00817                cm-\/>state = STATE\_needed;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00818}00818             \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00819}00819             cm-\/>priority = priority;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00820}00820          \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00821}00821       \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00822}00822    \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00823}00823 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00824}00824    \textcolor{comment}{// draw front-\/to-\/back}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00825}00825    \textcolor{keywordflow}{for} (rad = 0; rad <= view\_dist\_in\_chunks; rad += 2) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00826}00826       \textcolor{keywordflow}{for} (j=-\/rad; j <= rad; j += 2) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00827}00827          \textcolor{comment}{// if j is +-\/ rad, then iterate i through all values}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00828}00828          \textcolor{comment}{// if j isn't +-\/rad, then i should be only -\/rad \& rad}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00829}00829          \textcolor{keywordtype}{int} \mbox{\hyperlink{group__core__func__common_ga015a1261ff23e12650211aa872863cce}{step}} = 2;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00830}00830          \textcolor{keywordflow}{if} (\mbox{\hyperlink{group__core__func__common_ga693d77696ff36572a0da79efec965acd}{abs}}(j) != rad)}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00831}00831             \mbox{\hyperlink{group__core__func__common_ga015a1261ff23e12650211aa872863cce}{step}} = 2*rad;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00832}00832          \textcolor{keywordflow}{for} (i=-\/rad; i <= rad; i += \mbox{\hyperlink{group__core__func__common_ga015a1261ff23e12650211aa872863cce}{step}}) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00833}00833             \textcolor{keywordtype}{int} cx = qchunk\_x + i;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00834}00834             \textcolor{keywordtype}{int} cy = qchunk\_y + j;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00835}00835             \textcolor{keywordtype}{int} slot\_x = (cx>>1) \& (CACHED\_MESH\_NUM\_X-\/1);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00836}00836             \textcolor{keywordtype}{int} slot\_y = (cy>>1) \& (CACHED\_MESH\_NUM\_Y-\/1);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00837}00837             \mbox{\hyperlink{structchunk__mesh}{chunk\_mesh}} *cm = \&cached\_chunk\_mesh[slot\_y][slot\_x];}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00838}00838             \textcolor{keywordflow}{if} (cm-\/>state == STATE\_valid \&\& cm-\/>priority >= 0) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00839}00839                ++chunks\_considered;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00840}00840                quads\_considered += cm-\/>num\_quads;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00841}00841                \textcolor{keywordflow}{if} (is\_box\_in\_frustum(cm-\/>bounds[0], cm-\/>bounds[1])) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00842}00842                   ++chunks\_in\_frustum;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00843}00843 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00844}00844                   \textcolor{comment}{// @TODO if in range}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00845}00845                   stbglUniform3fv(uniform\_loc[STBVOX\_UNIFORM\_transform], 3, cm-\/>transform[0]);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00846}00846                   glBindBufferARB(GL\_ARRAY\_BUFFER\_ARB, cm-\/>vbuf);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00847}00847                   glVertexAttribIPointer(0, 1, GL\_UNSIGNED\_INT, 4, (\textcolor{keywordtype}{void}*) 0);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00848}00848                   glBindTexture(GL\_TEXTURE\_BUFFER\_ARB, cm-\/>fbuf\_tex);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00849}00849                   glDrawArrays(GL\_QUADS, 0, cm-\/>num\_quads*4);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00850}00850                   quads\_rendered += cm-\/>num\_quads;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00851}00851 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00852}00852                   chunk\_storage\_rendered += cm-\/>vbuf\_size + cm-\/>fbuf\_size;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00853}00853                \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00854}00854                chunk\_storage\_considered += cm-\/>vbuf\_size + cm-\/>fbuf\_size;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00855}00855             \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00856}00856          \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00857}00857       \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00858}00858    \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00859}00859 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00860}00860    stbglDisableVertexAttribArray(0);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00861}00861    glBindBufferARB(GL\_ARRAY\_BUFFER\_ARB, 0);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00862}00862    glActiveTextureARB(GL\_TEXTURE0\_ARB);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00863}00863 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00864}00864    stbglUseProgram(0);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00865}00865    num\_meshes\_started = 0;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00866}00866 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00867}00867    \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00868}00868 \textcolor{preprocessor}{      \#define MAX\_QUEUE  8}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00869}00869       \textcolor{keywordtype}{float} highest\_priority[MAX\_QUEUE];}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00870}00870       \textcolor{keywordtype}{int} highest\_i[MAX\_QUEUE], highest\_j[MAX\_QUEUE];}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00871}00871       \textcolor{keywordtype}{float} lowest\_priority = view\_dist\_in\_chunks * view\_dist\_in\_chunks * 16 * 16.0f;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00872}00872       \textcolor{keywordtype}{int} lowest\_i = -\/1, lowest\_j = -\/1;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00873}00873 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00874}00874       \textcolor{keywordflow}{for} (i=0; i < MAX\_QUEUE; ++i) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00875}00875          highest\_priority[i] = min\_priority;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00876}00876          highest\_i[i] = -\/1;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00877}00877          highest\_j[i] = -\/1;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00878}00878       \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00879}00879 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00880}00880       \textcolor{keywordflow}{for} (j=0; j < CACHED\_MESH\_NUM\_Y; ++j) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00881}00881          \textcolor{keywordflow}{for} (i=0; i < CACHED\_MESH\_NUM\_X; ++i) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00882}00882             \mbox{\hyperlink{structchunk__mesh}{chunk\_mesh}} *cm = \&cached\_chunk\_mesh[j][i];}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00883}00883             \textcolor{keywordflow}{if} (cm-\/>state == STATE\_valid) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00884}00884                cm-\/>priority = compute\_priority(cm-\/>chunk\_x, cm-\/>chunk\_y, x, y);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00885}00885                chunk\_storage\_total += cm-\/>vbuf\_size + cm-\/>fbuf\_size;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00886}00886                \textcolor{keywordflow}{if} (cm-\/>priority < lowest\_priority) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00887}00887                   lowest\_priority = cm-\/>priority;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00888}00888                   lowest\_i = i;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00889}00889                   lowest\_j = j;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00890}00890                \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00891}00891             \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00892}00892             \textcolor{keywordflow}{if} (cm-\/>state == STATE\_needed) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00893}00893                cm-\/>priority = compute\_priority(cm-\/>chunk\_x, cm-\/>chunk\_y, x, y);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00894}00894                \textcolor{keywordflow}{if} (cm-\/>priority < min\_priority)}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00895}00895                   cm-\/>state = STATE\_invalid;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00896}00896                \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (cm-\/>priority > highest\_priority[0]) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00897}00897                   \textcolor{keywordtype}{int} k;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00898}00898                   highest\_priority[0] = cm-\/>priority;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00899}00899                   highest\_i[0] = i;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00900}00900                   highest\_j[0] = j;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00901}00901                   \textcolor{comment}{// bubble this up to right place}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00902}00902                   \textcolor{keywordflow}{for} (k=0; k < MAX\_QUEUE-\/1; ++k) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00903}00903                      \textcolor{keywordflow}{if} (highest\_priority[k] > highest\_priority[k+1]) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00904}00904                         highest\_priority[k] = highest\_priority[k+1];}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00905}00905                         highest\_priority[k+1] = cm-\/>priority;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00906}00906                         highest\_i[k] = highest\_i[k+1];}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00907}00907                         highest\_i[k+1] = i;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00908}00908                         highest\_j[k] = highest\_j[k+1];}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00909}00909                         highest\_j[k+1] = j;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00910}00910                      \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00911}00911                         \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00912}00912                      \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00913}00913                   \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00914}00914                \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00915}00915             \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00916}00916          \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00917}00917       \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00918}00918 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00919}00919 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00920}00920       \textcolor{comment}{// I couldn't find any straightforward logic that avoids}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00921}00921       \textcolor{comment}{// the hysteresis problem of continually creating \& freeing}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00922}00922       \textcolor{comment}{// a block on the margin, so I just don't free a block until}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00923}00923       \textcolor{comment}{// it's out of range, but this doesn't actually correctly}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00924}00924       \textcolor{comment}{// handle when the cache is too small for the given range}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00925}00925       \textcolor{keywordflow}{if} (chunk\_storage\_total >= min\_chunk\_storage \&\& lowest\_i >= 0) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00926}00926          \textcolor{keywordflow}{if} (cached\_chunk\_mesh[lowest\_j][lowest\_i].priority < -\/1200) \textcolor{comment}{// -\/1000? 0?}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00927}00927             free\_chunk(lowest\_i, lowest\_j);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00928}00928       \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00929}00929 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00930}00930       \textcolor{keywordflow}{if} (chunk\_storage\_total < max\_chunk\_storage \&\& highest\_i[0] >= 0) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00931}00931          \textcolor{keywordflow}{for} (j=MAX\_QUEUE-\/1; j >= 0; -\/-\/j) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00932}00932             \textcolor{keywordflow}{if} (highest\_j[0] >= 0) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00933}00933                \mbox{\hyperlink{structchunk__mesh}{chunk\_mesh}} *cm = \&cached\_chunk\_mesh[highest\_j[j]][highest\_i[j]];}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00934}00934                \textcolor{keywordflow}{if} (request\_chunk(cm-\/>chunk\_x, cm-\/>chunk\_y)) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00935}00935                   cm-\/>state = STATE\_requested;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00936}00936                \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00937}00937                   \textcolor{comment}{// if we couldn't queue this one, skip the remainder}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00938}00938                   \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00939}00939                \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00940}00940             \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00941}00941          \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00942}00942       \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00943}00943    \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00944}00944 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00945}00945    update\_meshes\_from\_render\_thread();}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00946}00946 }
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00947}00947    num\_threads\_active = 0;}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00948}00948    \textcolor{keywordflow}{for} (i=0; i < num\_mesh\_workers; ++i) \{}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00949}00949       num\_threads\_active += (mesh\_data[i].state == WSTATE\_running);}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00950}00950    \}}
\DoxyCodeLine{\Hypertarget{cave__render_8c_source_l00951}00951 \}}

\end{DoxyCode}
