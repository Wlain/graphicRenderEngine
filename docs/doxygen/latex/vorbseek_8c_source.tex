\hypertarget{vorbseek_8c_source}{}\doxysection{vorbseek.\+c}
\label{vorbseek_8c_source}\index{/Users/cwb/developer/learning/graphicRenderEngine/ceres/3rdparty/stb/tests/vorbseek/vorbseek.c@{/Users/cwb/developer/learning/graphicRenderEngine/ceres/3rdparty/stb/tests/vorbseek/vorbseek.c}}

\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00001}00001 \textcolor{preprocessor}{\#include <assert.h>}}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00002}00002 \textcolor{preprocessor}{\#include <string.h>}}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00003}00003 \textcolor{preprocessor}{\#include <stdlib.h>}}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00004}00004 \textcolor{preprocessor}{\#include <stdio.h>}}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00005}00005 }
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00006}00006 \textcolor{preprocessor}{\#define STB\_VORBIS\_HEADER\_ONLY}}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00007}00007 \textcolor{preprocessor}{\#include "{}stb\_vorbis.c"{}}}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00008}00008 }
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00009}00009 \textcolor{preprocessor}{\#define SAMPLES\_TO\_TEST 3000}}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00010}00010 }
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00011}00011 \textcolor{keywordtype}{int} test\_count  [5] = \{ 5000, 3000, 2000, 50000, 50000 \};}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00012}00012 \textcolor{keywordtype}{int} test\_spacing[5] = \{    1,  111, 3337,  7779, 72717 \};}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00013}00013 }
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00014}00014 \textcolor{keywordtype}{int} try\_seeking(\mbox{\hyperlink{structstb__vorbis}{stb\_vorbis}} *v, \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} pos, \textcolor{keywordtype}{short} *\mbox{\hyperlink{structoutput}{output}}, \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} num\_samples)}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00015}00015 \{}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00016}00016    \textcolor{keywordtype}{int} count;}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00017}00017    \textcolor{keywordtype}{short} samples[SAMPLES\_TO\_TEST*2];}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00018}00018    assert(pos <= num\_samples);}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00019}00019 }
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00020}00020    \textcolor{keywordflow}{if} (!stb\_vorbis\_seek(v, pos)) \{}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00021}00021       fprintf(stderr, \textcolor{stringliteral}{"{}Seek to \%u returned error from stb\_vorbis\(\backslash\)n"{}}, pos);}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00022}00022       \textcolor{keywordflow}{return} 0;}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00023}00023    \}}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00024}00024 }
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00025}00025    count = stb\_vorbis\_get\_samples\_short\_interleaved(v, 2, samples, SAMPLES\_TO\_TEST*2);}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00026}00026 }
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00027}00027    \textcolor{keywordflow}{if} (count > (\textcolor{keywordtype}{int}) (num\_samples -\/ pos)) \{}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00028}00028       fprintf(stderr, \textcolor{stringliteral}{"{}Seek to \%u allowed decoding \%d samples when only \%d should have been valid.\(\backslash\)n"{}},}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00029}00029             pos, count, (\textcolor{keywordtype}{int}) (num\_samples -\/ pos));}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00030}00030       \textcolor{keywordflow}{return} 0;}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00031}00031    \}}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00032}00032 }
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00033}00033    \textcolor{keywordflow}{if} (count < SAMPLES\_TO\_TEST \&\& count < (\textcolor{keywordtype}{int}) (num\_samples -\/ pos)) \{}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00034}00034       fprintf(stderr, \textcolor{stringliteral}{"{}Seek to \%u only decoded \%d samples of \%d attempted when at least \%d should have been valid.\(\backslash\)n"{}},}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00035}00035          pos, count, SAMPLES\_TO\_TEST, num\_samples -\/ pos);}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00036}00036       \textcolor{keywordflow}{return} 0;                      }
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00037}00037    \}}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00038}00038 }
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00039}00039    \textcolor{keywordflow}{if} (0 != memcmp(samples, \mbox{\hyperlink{structoutput}{output}} + pos*2, count*2)) \{}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00040}00040       \textcolor{keywordtype}{int} k;}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00041}00041       \textcolor{keywordflow}{for} (k=0; k < SAMPLES\_TO\_TEST*2; ++k) \{}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00042}00042          \textcolor{keywordflow}{if} (samples[k] != \mbox{\hyperlink{structoutput}{output}}[k]) \{}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00043}00043             fprintf(stderr, \textcolor{stringliteral}{"{}Seek to \%u produced incorrect samples starting at sample \%u (short \#\%d in buffer).\(\backslash\)n"{}},}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00044}00044                     pos, pos + (k/2), k);}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00045}00045             \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00046}00046          \}}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00047}00047       \}}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00048}00048       assert(k != SAMPLES\_TO\_TEST*2);}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00049}00049       \textcolor{keywordflow}{return} 0;}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00050}00050    \}}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00051}00051 }
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00052}00052    \textcolor{keywordflow}{return} 1;}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00053}00053 \}}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00054}00054 }
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00055}00055 \textcolor{keywordtype}{int} main(\textcolor{keywordtype}{int} argc, \textcolor{keywordtype}{char} **argv)}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00056}00056 \{}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00057}00057    \textcolor{keywordtype}{int} num\_chan, samprate;}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00058}00058    \textcolor{keywordtype}{int} i, j, test, phase;}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00059}00059    \textcolor{keywordtype}{short} *\mbox{\hyperlink{structoutput}{output}};}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00060}00060 }
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00061}00061    \textcolor{keywordflow}{if} (argc == 1) \{}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00062}00062       fprintf(stderr, \textcolor{stringliteral}{"{}Usage: vorbseek \{vorbisfile\} [\{vorbisfile]*]\(\backslash\)n"{}});}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00063}00063       fprintf(stderr, \textcolor{stringliteral}{"{}Tests various seek offsets to make sure they're sample exact.\(\backslash\)n"{}});}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00064}00064       \textcolor{keywordflow}{return} 0;}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00065}00065    \}}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00066}00066 }
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00067}00067 \textcolor{preprocessor}{   \#if 0}}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00068}00068    \{}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00069}00069       \textcolor{comment}{// check that outofmem occurs correctly}}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00070}00070       \mbox{\hyperlink{structstb__vorbis__alloc}{stb\_vorbis\_alloc}} va;}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00071}00071       va.alloc\_buffer = malloc(1024*1024);}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00072}00072       \textcolor{keywordflow}{for} (i=0; i < 1024*1024; i += 10) \{}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00073}00073          \textcolor{keywordtype}{int} error=0;}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00074}00074          \mbox{\hyperlink{structstb__vorbis}{stb\_vorbis}} *v;}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00075}00075          va.alloc\_buffer\_length\_in\_bytes = i;}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00076}00076          v = stb\_vorbis\_open\_filename(argv[1], \&error, \&va);}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00077}00077          \textcolor{keywordflow}{if} (v != NULL)}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00078}00078             \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00079}00079          printf(\textcolor{stringliteral}{"{}Error \%d at \%d\(\backslash\)n"{}}, error, i);}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00080}00080       \}}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00081}00081    \}}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00082}00082 \textcolor{preprocessor}{   \#endif}}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00083}00083 }
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00084}00084    \textcolor{keywordflow}{for} (j=1; j < argc; ++j) \{}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00085}00085       \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} successes=0, attempts = 0;}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00086}00086       \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} num\_samples = stb\_vorbis\_decode\_filename(argv[j], \&num\_chan, \&samprate, \&\mbox{\hyperlink{structoutput}{output}});}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00087}00087 }
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00088}00088       \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00089}00089 }
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00090}00090       \textcolor{keywordflow}{if} (num\_samples == 0xffffffff) \{}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00091}00091          fprintf(stderr, \textcolor{stringliteral}{"{}Error: couldn't open file or not vorbis file: \%s\(\backslash\)n"{}}, argv[j]);}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00092}00092          \textcolor{keywordflow}{goto} fail;}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00093}00093       \}}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00094}00094 }
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00095}00095       \textcolor{keywordflow}{if} (num\_chan != 2) \{}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00096}00096          fprintf(stderr, \textcolor{stringliteral}{"{}vorbseek testing only works with files with 2 channels, \%s has \%d\(\backslash\)n"{}}, argv[j], num\_chan);}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00097}00097          \textcolor{keywordflow}{goto} fail;}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00098}00098       \}}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00099}00099 }
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00100}00100       \textcolor{keywordflow}{for} (test=0; test < 5; ++test) \{}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00101}00101          \textcolor{keywordtype}{int} error;}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00102}00102          \mbox{\hyperlink{structstb__vorbis}{stb\_vorbis}} *v = stb\_vorbis\_open\_filename(argv[j], \&error, NULL);}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00103}00103          \textcolor{keywordflow}{if} (v == NULL) \{}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00104}00104             fprintf(stderr, \textcolor{stringliteral}{"{}Couldn't re-\/open \%s for test \#\%d\(\backslash\)n"{}}, argv[j], test);}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00105}00105             \textcolor{keywordflow}{goto} fail;}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00106}00106          \}}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00107}00107          \textcolor{keywordflow}{for} (phase=0; phase < 3; ++phase) \{}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00108}00108             \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} base = phase == 0 ? 0 : phase == 1 ? num\_samples -\/ test\_count[test]*test\_spacing[test] : num\_samples/3;}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00109}00109             \textcolor{keywordflow}{for} (i=0; i < test\_count[test]; ++i) \{}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00110}00110                \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} pos = base + i*test\_spacing[test];}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00111}00111                \textcolor{keywordflow}{if} (pos > num\_samples) \textcolor{comment}{// this also catches underflows}}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00112}00112                   \textcolor{keywordflow}{continue};}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00113}00113                successes += try\_seeking(v, pos, \mbox{\hyperlink{structoutput}{output}}, num\_samples);}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00114}00114                attempts += 1;}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00115}00115             \}}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00116}00116          \}}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00117}00117          stb\_vorbis\_close(v);}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00118}00118       \}}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00119}00119       printf(\textcolor{stringliteral}{"{}\%d of \%d seeks failed in \%s (\%d samples)\(\backslash\)n"{}}, attempts-\/successes, attempts, argv[j], num\_samples);}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00120}00120       free(\mbox{\hyperlink{structoutput}{output}});}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00121}00121    \}}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00122}00122    \textcolor{keywordflow}{return} 0;}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00123}00123   fail:}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00124}00124    \textcolor{keywordflow}{return} 1;}
\DoxyCodeLine{\Hypertarget{vorbseek_8c_source_l00125}00125 \}}

\end{DoxyCode}
